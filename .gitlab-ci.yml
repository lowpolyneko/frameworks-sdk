# .gitlab-ci.yml
# Build frameworks nightly wheels on Aurora.
include:
  - project: 'anl/ci-resources/defaults'
    ref: main
    file:
      - '/runners.yml'

stages:
  - build

variables:
  # build in /tmp instead of on Lustre
  BUILD_ROOT: "/tmp/frameworks-nightly/builds"
  # where to collect logs and wheels on Lustre
  REMOTE_ROOT: "/lus/flare/projects/datascience/ewong25/.frameworks-nightly"
  # clone submodules
  GIT_SUBMODULE_STRATEGY: recursive
  HTTP_PROXY:  "http://proxy.alcf.anl.gov:3128"
  HTTPS_PROXY: "http://proxy.alcf.anl.gov:3128"
  http_proxy:  "http://proxy.alcf.anl.gov:3128"
  https_proxy: "http://proxy.alcf.anl.gov:3128"

pytorch:
  stage: build
  extends: .aurora-shell-runner
  # scheduler parameters
  variables:
    ANL_AURORA_SCHEDULER_PARAMETERS: "-A datascience -l select=1,walltime=06:00:00,filesystems=home:flare -q prod"
  script:
    - cd frameworks-standalone/nightly_wheels
    - ./pytorch.sh

  artifacts:
    name: "nightly-wheels-${ENV_NAME}"
    when: always
    expire_in: never
    paths:
      - "**/*.whl"

ipex:
  stage: build
  extends: .aurora-shell-runner
  # scheduler parameters
  variables:
    ANL_AURORA_SCHEDULER_PARAMETERS: "-A datascience -l select=1,walltime=06:00:00,filesystems=home:flare -q prod"
  needs:
    - job: pytorch
  script:
    - cd frameworks-standalone/nightly_wheels
    - ./ipex.sh -t *.whl

  artifacts:
    name: "nightly-wheels-${ENV_NAME}"
    when: always
    expire_in: never
    paths:
      - "**/*.whl"
